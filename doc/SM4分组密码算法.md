# SM4分组密码算法

## 1 符号

$\oplus$：32位异或

<<< i：32位循环左移 i 位

$\Z^n_2$：比特长度为n的二进制序列集合

## 2 密钥及密钥参量

​	密钥长度为128比特，表示为$MK=(MK_0,MK_1,MK_2,MK_3)$,其中$MK_i(i=0,1,2,3)$为字。

​	轮密钥表示为($rk_0,rk_1,...,rk_{31}$)，其中$rk_i(i=0,...,31)$为32比特字。轮密钥由密钥生成。

​	$FK=(FK_0,FK_1,FK_2,FK_3)$为系统参数，$CK=(CK_0,CK_1,CK_2,CK_3)$为固定参数，用于密钥扩展算法，其中$FK_i(i=0,1,2,3)、CK_i(i=0,1,2,3)$为字。

## 3 轮函数 F

### 3.1 轮函数结构

​	设输入为$(X_0,X_1,X_2,X_3) \in (Z^{32}_2)^4,$轮密钥为$rk \in Z^{32}_2$,则轮函数F见式(1):
$$
F(X_0,X_1,X_2,X_3,rk) = X_0 \oplus T(X_1 \oplus X_2 \oplus X_3 \oplus rk) \tag{1}
$$

### 3.2 合成置换 T

​	$T:Z^{32}_2 \rightarrow Z^{32}_2$是一个可逆变换，由非线性变换$\tau$和线性变换L复合而成，即$T(.)=L(\tau(.))$。

​	(a)非线性变换$\tau$

​	$\tau$由4个并行的S盒构成。

​	设输入为$A=(a_0,a_1,a_2,a_3) \in (Z^8_2)^4$,输出为$B=(b_0,b_1,b_2,b_3) \in (Z^8_2)^4$,则见式(2):
$$
(b_0,b_1,b_2,b_3) = \tau(A) = (Sbox(a_0),Sbox(a_1),Sbox(a_2),Sbox(a_3)) \tag{2}
$$
​	Sbox数据见下表：

![sm4-1](.\pic\sm4-1.png)

![sm4-2](.\pic\sm4-2.png)

​	(b)线性变换L

​	非线性变换$\tau$的输出是线性变换L的输入。设输入为$B \in Z^{32}_2$，则见式(3):
$$
C = L(B) = B \oplus (B<<<2)\oplus(B<<<10)\oplus(B<<<18)\oplus(B<<<24) \tag{3}
$$

## 4 算法描述

### 4.1 加密算法

​	本加密算法由32次迭代运算和1次反序变换R组成。

​	设明文输入为$(X_0,X_1,X_2,X_3) \in (Z^{32}_2)^4$，密文输出为$(Y_0,Y_1,Y_2,Y_3) \in (Z^{32}_2)^4$，轮密钥为$rk_i \in Z^{32}_2,i=0,1,2,...,31$。加密算法的运算过程如下：

(a)32次迭代运算见式(4):
$$
X_{i+4} = F(X_i,X_{i+1},X_{i+2},X_{i+3},rk_i),i = 0,1,..,31 \tag{4}
$$
(b)反序变换见式(5):
$$
(Y_0,Y_1,Y_2,Y_3) = R(X_{32},X_{33},X_{34},X_{35}) = (X_{35},X_{34},X_{33},X_{32}) \tag{5}
$$

### 4.2 解密算法

​	本算法的解密变换与加密变换结构相同，不同的仅是轮密钥的使用顺序。解密时，使用轮密钥序$(rk_{31},rk_{30},...,rk_0)$。

### 4.3 密钥扩展算法

​	加密过程使用的轮密钥由加密密钥生成，其中加密密钥$MK=(MK_0,MK_1,MK_2,MK_3) \in (Z^{32}_2)^4$，加密过程中的轮密钥生成方式见式(6)和式(7):
$$
(K_0,K_1,K_2,K_3)=(MK_0 \oplus FK_0,MK_1 \oplus FK_1,MK_2 \oplus FK_2,MK_3 \oplus FK_3) \tag{6} \\
$$

$$
rk_i = K_{i+4} = K_i \oplus T'(K_{i+1} \oplus K_{i+2} \oplus K_{i+3} \oplus CK_i),i=0,1,...,31 \tag{7}
$$

式中：

a)T'是将6.2中合成置换 T 的线性变换 L 替换为 L‘，见式(8):
$$
L'(B) = B \oplus (B<<<13) \oplus (B<<<23) \tag{8}
$$
b)系统参数FK的取值为:
$$
FK_0 = (A3B1BAC6),FK_1 = (56AA3350),FK_2 = (677D9197),FK_3 = (B27022DC)
$$
c)固定参数CK取值方法为：

$ck_{i,j}为CK_i的第j字节(i=0,1,...,31;j=0,1,2,3)，即CK_i=(ck_{i,0},ck_{i,1},ck_{i,2},ck_{i,3}) \in (Z^8_2)^4,则ck_{i,j}=(4i+j)x7(mod256)$

固定参数$CK_i(i=0,1,...,31)$具体值为:

![sm4-3](.\pic\sm4-3.png)

​	解密密钥同加密密钥，解密使用的轮密钥由解密密钥生成，其轮密钥生成方法同加密过程的轮密钥生成方法。